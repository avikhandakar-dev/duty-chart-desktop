(function(){"use strict";function d(n,r){if(n.length===0)return 0;const t=Math.min(n.length-1,Math.max(0,Math.floor(r*(n.length-1))));return n[t]}function R(n,r){if(n.length===0)return[];const t=[...n].sort((o,c)=>o-c),s=d(t,1-r),e=d(t,r);return n.map(o=>Math.max(s,Math.min(e,o)))}function E(n,r){let t=0,s=0,e=0;const o=Math.min(n.length,r.length);for(let a=0;a<o;a++)t+=n[a]*r[a],s+=n[a]*n[a],e+=r[a]*r[a];const c=Math.sqrt(s)*Math.sqrt(e);return c>1e-12?1-t/c:1}function q(n,r){const t=n.length,s=r.length,e=new Float32Array((t+1)*(s+1));for(let o=0;o<=t;o++)e[o*(s+1)]=1/0;for(let o=0;o<=s;o++)e[o]=1/0;e[0]=0;for(let o=1;o<=t;o++)for(let c=1;c<=s;c++){const a=Math.abs(n[o-1]-r[c-1]),u=o*(s+1)+c,h=e[u-1],l=e[(o-1)*(s+1)+c],m=e[(o-1)*(s+1)+(c-1)];e[u]=a+Math.min(h,l,m)}return e[t*(s+1)+s]/Math.max(1,t+s)}function A(n,r){const t=[];for(let s=0;s<n.length;s++){const e=Math.max(0,s-r+1);let o=0,c=0;for(let a=e;a<=s;a++)o+=Math.max(0,n[a].high-n[a].low),c++;t.push(o/Math.max(1,c))}return t}function B(n,r,t,s){const e=n[t].close,o=[],c=[],a=[];let u=0,h=0,l=0;for(let m=1;m<=s;m++){const f=t+m;u=(n[f].close-e)/Math.max(1e-8,r[t]),h=Math.max(h,(n[f].high-e)/Math.max(1e-8,r[t])),l=Math.max(l,(e-n[f].low)/Math.max(1e-8,r[t])),o.push(u),c.push(h),a.push(l)}return{ret:o[o.length-1],mfe:c[c.length-1],mae:a[a.length-1],path:o}}function C(n,r,t,s){const e={};for(const o of s.horizons){const c=[],a=[],u=[],h=[],l=[];for(const M of n){if(M.j+o>=r.length)continue;const x=B(r,t,M.j,o);c.push(x.ret),a.push(x.mfe),u.push(x.mae),h.push(x.path),l.push(M.w)}const m=[...c].sort((M,x)=>M-x),f=[...a].sort((M,x)=>M-x),v=[...u].sort((M,x)=>M-x),y=d(m,.1),i=d(m,.5),p=d(m,.9),w=d(f,.1),g=d(f,.5),P=d(f,.9),L=d(v,.1),S=d(v,.5),F=d(v,.9),z=[],j=[],H=[],U=o;for(let M=0;M<U;M++){const x=h.map(b=>b[M]).sort((b,J)=>b-J);z.push(d(x,.5)),j.push(d(x,.1)),H.push(d(x,.9))}const T=m.filter(M=>M<y).length/Math.max(1,m.length),W=m.filter(M=>M>p).length/Math.max(1,m.length),G=1-T-W;e[o]={retP10:y,retP50:i,retP90:p,mfeP10:w,mfeP50:g,mfeP90:P,maeP10:L,maeP50:S,maeP90:F,forwardPathMedian:z,forwardPathP10:j,forwardPathP90:H,terciles:{fade:T,base:G,extend:W}}}return e}function D(n,r,t,s){const e=[];for(const o of s.showBothDirections?["long","short"]:["long"])for(const c of s.candidateSL){const a=[],u=[];let h=0,l=0;for(const g of s.horizons)for(const P of n){if(P.j+g>=r.length)continue;const L=B(r,t,P.j,g),S=L.ret,F=c,z=o==="long"?Math.max(0,S):Math.max(0,-S),j=o==="long"?Math.max(0,L.mae-F):Math.max(0,L.mfe-F);z>j?(a.push(z),h++):u.push(j),l++}const m=R(a,s.winsor),f=R(u,s.winsor),v=m.reduce((g,P)=>g+P,0)/Math.max(1,m.length),y=f.reduce((g,P)=>g+P,0)/Math.max(1,f.length),i=l>0?h/l:0,p=i*v-(1-i)*y,w=d(R(n.map(g=>B(r,t,g.j,Math.max(...s.horizons)).mae),s.winsor).sort((g,P)=>g-P),.9);e.push({side:o,mult:c,ev:p,pWin:i,avgWinR:v,avgLossR:y,maeP90:w})}return e.sort((o,c)=>c.ev-o.ev),e}function I(n,r,t){const s=[],e=t.windowBars;for(let h=0;h+e+Math.max(...t.horizons)<n.length;h+=t.stride){const l=n.slice(h,h+e),m=K(l,t),f=t.distance==="cosine"?E(r,m):q(r,m);s.push({j:h,d:f})}s.sort((h,l)=>h.d-l.d);const o=1e-6,c=t.halfLifeBars,a=Math.min(t.topK,s.length);return s.slice(0,a).map(h=>{const l=Math.exp(-(n.length-(h.j+e))/Math.max(1,c)),m=1/(o+h.d)*l;return{j:h.j,w:m}})}function K(n,r){const t=i=>{const p=[];for(let w=i;w<n.length;w++){const g=(n[w].close-n[w-i].close)/Math.max(1e-8,n[w-i].close);p.push(g)}return p},s=t(1),e=t(2),o=t(3),c=t(5),a=A(n,r.atrLen),u=[];for(let i=0;i<a.length;i++){const p=a[Math.max(0,i-4)],w=a[i];u.push(w-p)}const h=[];for(let i=0;i<n.length;i++){const p=n[i],w=Math.max(1e-8,p.high-p.low),g=Math.abs(p.close-p.open);h.push(g/w)}const l=[...s,...e,...o,...c,...a,...u,...h],m=l.reduce((i,p)=>i+p,0)/Math.max(1,l.length),f=Math.sqrt(l.reduce((i,p)=>i+Math.pow(p-m,2),0)/Math.max(1,l.length)),y=l.map(i=>(i-m)/(f>1e-8?f:1)).map(i=>Math.max(-5,Math.min(5,i)));return new Float32Array(y)}self.onmessage=n=>{const{id:r,settings:t,features:s,bars:e}=n.data;if(!e||e.length<t.windowBars+Math.max(...t.horizons)){const f={id:r,matches:0,byHorizon:{},slSuggest:{evTable:[]}};self.postMessage(f);return}const o=A(e,t.atrLen),c=I(e,s,t),a=C(c,e,o,t),u=D(c,e,o,t),h=u.filter(f=>f.side==="long")[0],l=u.filter(f=>f.side==="short")[0],m={id:r,matches:c.length,byHorizon:a,slSuggest:{long:h&&{mult:h.mult,ev:h.ev,maeP90:h.maeP90},short:l&&{mult:l.mult,ev:l.ev,maeP90:l.maeP90},evTable:u}};self.postMessage(m)}})();
